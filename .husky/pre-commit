#!/bin/sh

# Pre-commit hook for Platform Engineering Playbook
# Runs validation checks before allowing commits

echo "ğŸ” Running pre-commit checks..."
echo ""

# 1. Check for secrets/credentials
echo "ğŸ” Scanning for secrets and credentials..."
if command -v gitleaks >/dev/null 2>&1; then
  gitleaks protect --staged --verbose --redact --config .gitleaks.toml || {
    echo "âŒ Secret detection failed! Found potential secrets in staged files."
    echo "   Review the output above and remove any secrets before committing."
    echo "   If this is a false positive, update .gitleaks.toml allowlist."
    exit 1
  }
  echo "âœ“ No secrets detected"
else
  echo "âš ï¸  WARNING: gitleaks not installed - skipping secrets check"
  echo "   Install with: brew install gitleaks"
fi
echo ""

# 2. Validate MDX/Markdown files
echo "ğŸ“ Validating MDX/Markdown files..."
npm run test:mdx || exit 1
echo ""

# 3. Run TypeScript type checking
echo "ğŸ”§ Checking TypeScript types..."
npm run typecheck || exit 1
echo ""

# 4. Quick build test (faster than full build)
echo "ğŸ—ï¸  Testing Docusaurus build..."
npm run build || exit 1
echo ""

echo "âœ… All pre-commit checks passed!"
echo ""
