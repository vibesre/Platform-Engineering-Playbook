# K6

K6 is a modern load testing tool for developers and testers. It uses JavaScript ES6 to create test scripts and provides a developer-centric API for performance testing APIs, microservices, and websites.

## Installation

### Local Installation
```bash
# Install on macOS via Homebrew
brew install k6

# Install on Windows via Chocolatey
choco install k6

# Install on Ubuntu/Debian
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
sudo apt-get update
sudo apt-get install k6

# Install on CentOS/RHEL
sudo yum install -y epel-release
sudo yum install -y k6

# Install via npm (using the docker wrapper)
npm install -g k6
```

### Docker
```bash
# Run K6 tests using Docker
docker run --rm -i grafana/k6:latest run - < script.js

# With volume mount for local files
docker run --rm -v $(pwd):/app -w /app grafana/k6:latest run script.js

# With environment variables
docker run --rm -e K6_VUS=10 -e K6_DURATION=30s grafana/k6:latest run script.js
```

## Basic Usage

### Simple Load Test
```javascript
// basic-test.js
import http from 'k6/http';
import { check, sleep } from 'k6';

// Test configuration
export const options = {
  vus: 10, // 10 virtual users
  duration: '30s', // Test duration
};

export default function () {
  // Make HTTP request
  const response = http.get('https://httpbin.org/json');
  
  // Verify response
  check(response, {
    'status is 200': (r) => r.status === 200,
    'response time < 500ms': (r) => r.timings.duration < 500,
    'content type is JSON': (r) => r.headers['Content-Type'].includes('application/json'),
  });
  
  // Wait between iterations
  sleep(1);
}
```

### API Testing
```javascript
// api-test.js
import http from 'k6/http';
import { check, group, sleep } from 'k6';
import { Rate } from 'k6/metrics';

// Custom metrics
const errorRate = new Rate('errors');

export const options = {
  stages: [
    { duration: '2m', target: 20 }, // Ramp up to 20 users
    { duration: '5m', target: 20 }, // Stay at 20 users
    { duration: '2m', target: 50 }, // Ramp up to 50 users
    { duration: '5m', target: 50 }, // Stay at 50 users
    { duration: '2m', target: 0 },  // Ramp down to 0 users
  ],
  thresholds: {
    http_req_duration: ['p(95)<500'], // 95% of requests must complete below 500ms
    http_req_failed: ['rate<0.1'],   // Error rate must be below 10%
    errors: ['rate<0.1'],
  },
};

const BASE_URL = 'https://api.example.com';
const USERNAME = 'testuser';
const PASSWORD = 'testpass';

export function setup() {
  // Login and get auth token
  const loginRes = http.post(`${BASE_URL}/auth/login`, {
    username: USERNAME,
    password: PASSWORD,
  });
  
  check(loginRes, { 'login successful': (r) => r.status === 200 });
  
  return { authToken: loginRes.json('access_token') };
}

export default function (data) {
  const headers = {
    'Authorization': `Bearer ${data.authToken}`,
    'Content-Type': 'application/json',
  };

  group('User Management', function () {
    // Get user list
    group('Get Users', function () {
      const response = http.get(`${BASE_URL}/api/users`, { headers });
      const success = check(response, {
        'get users status is 200': (r) => r.status === 200,
        'get users response time < 200ms': (r) => r.timings.duration < 200,
        'users array exists': (r) => Array.isArray(r.json('data')),
      });
      
      if (!success) {
        errorRate.add(1);
      }
    });

    // Create user
    group('Create User', function () {
      const newUser = {
        name: `User-${Math.random().toString(36).substr(2, 9)}`,
        email: `user${Math.random().toString(36).substr(2, 9)}@example.com`,
        role: 'user',
      };

      const response = http.post(`${BASE_URL}/api/users`, JSON.stringify(newUser), { headers });
      const success = check(response, {
        'create user status is 201': (r) => r.status === 201,
        'create user response time < 300ms': (r) => r.timings.duration < 300,
        'user created has ID': (r) => r.json('id') !== undefined,
      });

      if (!success) {
        errorRate.add(1);
      }
      
      // Store user ID for potential cleanup
      if (response.status === 201) {
        const userId = response.json('id');
        // Use in subsequent requests if needed
      }
    });
  });

  group('Product Catalog', function () {
    const response = http.get(`${BASE_URL}/api/products?page=1&limit=10`, { headers });
    const success = check(response, {
      'products status is 200': (r) => r.status === 200,
      'products response time < 400ms': (r) => r.timings.duration < 400,
      'products has pagination': (r) => r.json('pagination') !== undefined,
    });
    
    if (!success) {
      errorRate.add(1);
    }
  });

  sleep(Math.random() * 3 + 1); // Random sleep between 1-4 seconds
}

export function teardown(data) {
  // Cleanup actions if needed
  console.log('Test completed');
}
```

## Load Testing Patterns

### Spike Testing
```javascript
// spike-test.js
import http from 'k6/http';
import { check } from 'k6';

export const options = {
  stages: [
    { duration: '10s', target: 100 }, // Rapid ramp up
    { duration: '1m', target: 100 },  // Stay at peak
    { duration: '10s', target: 0 },   // Rapid ramp down
  ],
  thresholds: {
    http_req_duration: ['p(95)<1000'],
    http_req_failed: ['rate<0.2'], // Allow higher error rate during spike
  },
};

export default function () {
  const response = http.get('https://api.example.com/health');
  check(response, {
    'status is 200': (r) => r.status === 200,
  });
}
```

### Stress Testing
```javascript
// stress-test.js
import http from 'k6/http';
import { check } from 'k6';

export const options = {
  stages: [
    { duration: '2m', target: 100 },  // Ramp up
    { duration: '5m', target: 100 },  // Stay at normal load
    { duration: '2m', target: 200 },  // Ramp up to high load
    { duration: '5m', target: 200 },  // Stay at high load
    { duration: '2m', target: 300 },  // Ramp up to very high load
    { duration: '5m', target: 300 },  // Stay at very high load
    { duration: '2m', target: 400 },  // Ramp up to extreme load
    { duration: '5m', target: 400 },  // Stay at extreme load
    { duration: '10m', target: 0 },   // Ramp down
  ],
  thresholds: {
    http_req_duration: ['p(95)<2000'],
    http_req_failed: ['rate<0.3'],
  },
};

export default function () {
  const response = http.get('https://api.example.com/products');
  check(response, {
    'status is 200': (r) => r.status === 200,
  });
}
```

### Volume Testing
```javascript
// volume-test.js
import http from 'k6/http';
import { check } from 'k6';

export const options = {
  scenarios: {
    constant_load: {
      executor: 'constant-vus',
      vus: 50,
      duration: '30m', // Extended duration for volume testing
    },
  },
  thresholds: {
    http_req_duration: ['p(95)<1000'],
    http_req_failed: ['rate<0.1'],
    iteration_duration: ['p(95)<5000'],
  },
};

export default function () {
  // Simulate realistic user behavior with multiple requests
  const responses = http.batch([
    ['GET', 'https://api.example.com/products'],
    ['GET', 'https://api.example.com/categories'],
    ['GET', 'https://api.example.com/users/profile'],
  ]);

  responses.forEach((response, index) => {
    check(response, {
      [`request ${index} status is 200`]: (r) => r.status === 200,
    });
  });
}
```

## Advanced Features

### Custom Metrics
```javascript
import http from 'k6/http';
import { check } from 'k6';
import { Counter, Gauge, Rate, Trend } from 'k6/metrics';

// Custom metrics
const customCounter = new Counter('custom_counter');
const customGauge = new Gauge('custom_gauge');
const customRate = new Rate('custom_rate');
const customTrend = new Trend('custom_trend');

export default function () {
  const response = http.get('https://api.example.com/data');
  
  // Update custom metrics
  customCounter.add(1);
  customGauge.add(response.timings.duration);
  customRate.add(response.status === 200);
  customTrend.add(response.timings.duration);
  
  check(response, {
    'status is 200': (r) => r.status === 200,
  });
}
```

### Data Parameterization
```javascript
// data-driven-test.js
import http from 'k6/http';
import { check } from 'k6';
import { SharedArray } from 'k6/data';

// Load test data
const users = new SharedArray('users', function () {
  return JSON.parse(open('./users.json'));
});

const products = new SharedArray('products', function () {
  return JSON.parse(open('./products.json'));
});

export default function () {
  // Get random user and product
  const user = users[Math.floor(Math.random() * users.length)];
  const product = products[Math.floor(Math.random() * products.length)];
  
  // Test with parameterized data
  const response = http.post('https://api.example.com/orders', JSON.stringify({
    userId: user.id,
    productId: product.id,
    quantity: Math.floor(Math.random() * 5) + 1,
  }), {
    headers: { 'Content-Type': 'application/json' },
  });
  
  check(response, {
    'order created': (r) => r.status === 201,
  });
}
```

### Scenarios and Executors
```javascript
// scenarios-test.js
export const options = {
  scenarios: {
    // Ramping VUs scenario
    ramping_load: {
      executor: 'ramping-vus',
      startVUs: 0,
      stages: [
        { duration: '5m', target: 20 },
        { duration: '10m', target: 20 },
        { duration: '5m', target: 0 },
      ],
      gracefulRampDown: '30s',
    },
    
    // Constant arrival rate scenario
    constant_request_rate: {
      executor: 'constant-arrival-rate',
      rate: 30, // 30 requests per second
      timeUnit: '1s',
      duration: '5m',
      preAllocatedVUs: 10,
      maxVUs: 50,
    },
    
    // Per VU iterations scenario
    shared_iterations: {
      executor: 'shared-iterations',
      vus: 10,
      iterations: 1000, // Total iterations shared among VUs
      maxDuration: '10m',
    },
  },
};

export default function () {
  // Test logic here
}
```

## CI/CD Integration

### GitHub Actions
```yaml
name: Load Testing

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * *' # Daily at 2 AM

jobs:
  load-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install K6
      run: |
        sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6
    
    - name: Run Load Tests
      run: |
        k6 run \
          --out json=results.json \
          --out influxdb=http://localhost:8086/k6 \
          --summary-trend-stats="min,med,avg,p(90),p(95),p(99),max" \
          tests/load-test.js
      env:
        K6_BASE_URL: ${{ secrets.TEST_BASE_URL }}
        K6_AUTH_TOKEN: ${{ secrets.TEST_AUTH_TOKEN }}
    
    - name: Parse Results
      run: |
        # Extract key metrics
        avg_duration=$(jq -r '.metrics.http_req_duration.values.avg' results.json)
        p95_duration=$(jq -r '.metrics.http_req_duration.values["p(95)"]' results.json)
        error_rate=$(jq -r '.metrics.http_req_failed.values.rate' results.json)
        
        echo "Average Response Time: ${avg_duration}ms"
        echo "95th Percentile: ${p95_duration}ms"
        echo "Error Rate: ${error_rate}"
        
        # Set thresholds
        if (( $(echo "$p95_duration > 1000" | bc -l) )); then
          echo "::error::95th percentile response time exceeded 1000ms"
          exit 1
        fi
        
        if (( $(echo "$error_rate > 0.05" | bc -l) )); then
          echo "::error::Error rate exceeded 5%"
          exit 1
        fi
    
    - name: Upload Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: k6-results
        path: results.json
```

### Docker Compose
```yaml
# docker-compose.k6.yml
version: '3.8'

services:
  k6:
    image: grafana/k6:latest
    volumes:
      - ./tests:/scripts
      - ./results:/results
    environment:
      - K6_OUT=json=/results/result.json
      - K6_WEB_DASHBOARD=true
      - K6_WEB_DASHBOARD_EXPORT=/results/report.html
    command: run /scripts/load-test.js
    depends_on:
      - influxdb
      - grafana
  
  influxdb:
    image: influxdb:1.8
    environment:
      - INFLUXDB_DB=k6
      - INFLUXDB_ADMIN_USER=admin
      - INFLUXDB_ADMIN_PASSWORD=admin
    ports:
      - "8086:8086"
    volumes:
      - influxdb-data:/var/lib/influxdb
  
  grafana:
    image: grafana/grafana:latest
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./grafana/datasources:/etc/grafana/provisioning/datasources

volumes:
  influxdb-data:
  grafana-data:
```

## Monitoring and Observability

### InfluxDB + Grafana Integration
```javascript
// monitoring-test.js
import http from 'k6/http';
import { check } from 'k6';

export const options = {
  ext: {
    influxdb: {
      organization: 'my-org',
      bucket: 'k6-results',
      token: __ENV.INFLUXDB_TOKEN,
    },
  },
};

export default function () {
  const response = http.get('https://api.example.com/health');
  
  check(response, {
    'status is 200': (r) => r.status === 200,
  }, { 
    // Tags for InfluxDB
    endpoint: 'health',
    region: __ENV.REGION || 'us-east-1',
  });
}
```

### Prometheus Metrics
```javascript
// prometheus-test.js
import http from 'k6/http';
import { check } from 'k6';

export const options = {
  ext: {
    prometheus: {
      host: 'localhost:9090',
      namespace: 'k6_',
    },
  },
};

export default function () {
  const response = http.get('https://api.example.com/metrics');
  
  check(response, {
    'status is 200': (r) => r.status === 200,
    'response contains metrics': (r) => r.body.includes('# HELP'),
  });
}
```

## Performance Testing Best Practices

### Test Organization
```javascript
// tests/utils/config.js
export const config = {
  baseUrl: __ENV.BASE_URL || 'https://api.example.com',
  authToken: __ENV.AUTH_TOKEN,
  stages: {
    smoke: [
      { duration: '1m', target: 1 },
    ],
    load: [
      { duration: '2m', target: 10 },
      { duration: '5m', target: 10 },
      { duration: '2m', target: 0 },
    ],
    stress: [
      { duration: '2m', target: 50 },
      { duration: '5m', target: 50 },
      { duration: '2m', target: 100 },
      { duration: '5m', target: 100 },
      { duration: '2m', target: 0 },
    ],
  },
  thresholds: {
    smoke: {
      http_req_duration: ['p(95)<500'],
      http_req_failed: ['rate<0.01'],
    },
    load: {
      http_req_duration: ['p(95)<800'],
      http_req_failed: ['rate<0.05'],
    },
    stress: {
      http_req_duration: ['p(95)<1200'],
      http_req_failed: ['rate<0.10'],
    },
  },
};

// tests/utils/helpers.js
import { check } from 'k6';

export function validateResponse(response, checks) {
  return check(response, checks);
}

export function randomString(length = 10) {
  return Math.random().toString(36).substring(2, length + 2);
}

export function randomEmail() {
  return `user-${randomString(5)}@example.com`;
}
```

### Error Handling
```javascript
import http from 'k6/http';
import { check, fail } from 'k6';

export default function () {
  let response;
  
  try {
    response = http.get('https://api.example.com/data', {
      timeout: '30s',
    });
  } catch (error) {
    fail(`Request failed: ${error.message}`);
  }
  
  // Graceful degradation for different status codes
  const success = check(response, {
    'status is 200': (r) => r.status === 200,
    'status is not 5xx': (r) => r.status < 500,
  });
  
  if (response.status >= 500) {
    console.error(`Server error: ${response.status} - ${response.body}`);
  } else if (response.status >= 400) {
    console.warn(`Client error: ${response.status} - ${response.body}`);
  }
  
  return success;
}
```

## Resources

- [K6 Documentation](https://k6.io/docs/)
- [K6 Examples](https://github.com/grafana/k6-examples)
- [K6 Extensions](https://k6.io/docs/extensions/)
- [Performance Testing Guide](https://k6.io/docs/testing-guides/)
- [K6 JavaScript API](https://k6.io/docs/javascript-api/)
- [K6 Grafana Dashboards](https://grafana.com/grafana/dashboards/2587)
- [K6 Cloud](https://k6.io/cloud/)
- [Load Testing Best Practices](https://k6.io/docs/testing-guides/load-testing-principles/)
- [Community Forum](https://community.k6.io/)
- [K6 GitHub Repository](https://github.com/grafana/k6)